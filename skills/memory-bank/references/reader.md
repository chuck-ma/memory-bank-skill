# Memory Bank Reader 规则

> 此文档定义 Memory Bank 的读取规则，由主 Agent 在每轮对话开始时执行。

## Memory Gate（强制）

开始任何工作前，按此顺序执行：

1. **Read** `memory-bank/_index.md`
2. **找到相关路径** → Read 这些文档
3. **然后** 才能使用 Glob/Grep/代码搜索

**禁止**：在完成步骤 1-2 前使用任何代码搜索工具。

---

## Memory-first 原则（强制）

**任何问题，先假设"可能已经记录过"**。

| 问题类型 | 优先查 |
|---------|--------|
| 当前在做什么/下一步 | active.md |
| 项目是什么/概述 | brief.md |
| 怎么设计的/为什么这样实现 | docs/design-*.md |
| 为什么选这个方案/技术决策 | patterns.md |
| 遇到过这问题吗/踩坑经验 | learnings/ |
| 需求背景/功能定义 | requirements/ |
| 怎么跑/怎么测试/环境配置 | tech.md、docs/ |

**搜索顺序**：`_index.md` → 对应目录 → 代码

**强制规则**：
- 找到答案 → 引用文件路径，直接回答
- `_index.md` 与对应目录检索无果，或找到但与代码/行为不一致 → 才读代码
- **若因文档缺失/过时而读了代码 → 这本身就是写入触发点**
  - 在回复中点名要新增/更新的目标文件路径
  - 说明要写入的 1-2 个要点

**冲突处理**：当文档与代码不一致时，以代码为准，但必须提议更新文档并引用路径。

---

## 智能检索

### 每轮对话流程

```
1. 固定加载：brief.md + active.md + _index.md（如存在）

2. 语义判断：
   - 基于 _index.md 选择相关文件
   - 输出决策：{ files: [...], reason: "..." }

3. 按预算加载选中文件
```

### 预算限制

| 类型 | 预算 |
|------|------|
| 固定加载（brief + active + _index） | 不限 |
| 每轮额外加载 | 最多 5 个文件 |
| 额外加载总行数 | 最多 500 行 |

### 超预算降级

当候选文件总 size 超过 500 行时：
1. 固定加载 brief.md + active.md + _index.md（不计入预算）
2. 按相关性排序候选文件
3. 按 size 从小到大依次加载
4. 累计 size 达到 500 行时停止
5. 未加载的文件提示用户："以下文件相关但未加载（预算限制）：..."

### 大文件处理

- 如果单个文件 > 200 行
- 只读取前 100 行 + 最后 50 行
- 中间插入 `[... 省略 {n} 行 ...]`

---

## 风险提示

如果 `learnings/` 下有相关历史经验，主动提醒：

```
注意：历史上有类似问题 → {file}
```

---

## 引用驱动的继续阅读

如果 `active.md` 或 `_index.md` 提到：
- `REQ-xxx` → 读取对应需求文档
- `patterns.md` → 读取技术决策
- 某模块文档 → 读取该文档

将这些当作**高优先级读取目标**。

---

## 陈旧检测

当 `active.md` 的"当前焦点"与用户最新目标明显不一致时：
- 先澄清："active.md 记录的焦点是 X，你现在想做 Y，是否需要更新？"
- 或直接建议更新（触发写入流程）

---

## 输出边界

上下文不足时：
- **先用工具**（grep/read）查找相关文件
- **禁止**仅凭 Memory Bank 缺失就断言"不存在"或"没有"

---

## 声明上下文来源

回答问题时，简短说明参考了哪些 Memory Bank 文件：

```
基于 brief.md 和 active.md，当前项目是...
```

---

## 不把 Memory Bank 当真理

Memory Bank 可能过时。如果与代码/配置矛盾：
- **优先以仓库实际内容为准**
- 建议更新 Memory Bank（触发写入流程）
